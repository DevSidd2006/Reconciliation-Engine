version: '3.8'

services:
  # Traefik Reverse Proxy with HTTPS (Self-Signed Certificates)
  traefik:
    image: traefik:v3.0
    container_name: reconciliation_traefik
    command:
      # Enable Docker provider
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      
      # Enable file provider for TLS configuration
      - --providers.file.directory=/etc/traefik/dynamic
      - --providers.file.watch=true
      
      # Configure entrypoints
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      
      # Redirect HTTP to HTTPS
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      
      # Enable API and dashboard (disable in production)
      - --api.dashboard=true
      - --api.insecure=true
      
      # Logging
      - --log.level=INFO
      - --accesslog=true
      
      # Security headers
      - --entrypoints.websecure.http.middlewares=security-headers@docker
    ports:
      - "80:80"
      - "443:443"
      - "8081:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik:/etc/traefik/certs:ro
      - ./traefik:/etc/traefik/dynamic:ro
    networks:
      - banking_network
    labels:
      # Dashboard configuration
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`localhost`) && PathPrefix(`/dashboard`)"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.service=api@internal"
      
      # Security headers middleware
      - "traefik.http.middlewares.security-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.security-headers.headers.sslredirect=true"
      - "traefik.http.middlewares.security-headers.headers.stsincludesubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.stspreload=true"
      - "traefik.http.middlewares.security-headers.headers.stsseconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.framedeny=true"
      - "traefik.http.middlewares.security-headers.headers.contenttypenosniff=true"
      - "traefik.http.middlewares.security-headers.headers.browserxssfilter=true"
      - "traefik.http.middlewares.security-headers.headers.referrerpolicy=strict-origin-when-cross-origin"

  # FastAPI Backend (internal only)
  api:
    build: .
    container_name: reconciliation_api
    environment:
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/reconciliation_db
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis123}@redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis123}
    env_file:
      - .env
    ports:
      - "8000:8000"  # Expose for development and testing
    depends_on:
      - postgres
      - redis
    networks:
      - banking_network
    # Disable healthcheck to prevent Traefik from ignoring unhealthy containers
    healthcheck:
      disable: true
    labels:
      - "traefik.enable=true"
      
      # API routing for HTTPS (NO JSON escaping)
      - "traefik.http.routers.api.rule=Host(`localhost`) && PathPrefix(`/api`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls=true"
      
      # API routing for HTTP (development)
      - "traefik.http.routers.api-http.rule=Host(`localhost`) && PathPrefix(`/api`)"
      - "traefik.http.routers.api-http.entrypoints=web"
      
      # Service configuration
      - "traefik.http.services.api.loadbalancer.server.port=8000"
      
      # Strip /api prefix middleware
      - "traefik.http.middlewares.api-strip-prefix.stripprefix.prefixes=/api"
      - "traefik.http.routers.api.middlewares=api-strip-prefix@docker"
      - "traefik.http.routers.api-http.middlewares=api-strip-prefix@docker"
      - "traefik.http.middlewares.api-auth.forwardauth.trustforwardheader=true"



  # PostgreSQL Database (internal only)
  postgres:
    image: postgres:15
    container_name: reconciliation_postgres
    environment:
      POSTGRES_DB: reconciliation_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - banking_network
    # No external ports - internal access only

  # Redis Cache (internal only)
  redis:
    image: redis:7-alpine
    container_name: reconciliation_redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis123}
    volumes:
      - redis_data:/data
    networks:
      - banking_network
    # No external ports - internal access only

volumes:
  postgres_data:
  redis_data:

networks:
  banking_network:
    driver: bridge
    ipam:
      config:
        - subnet: ${INTERNAL_NETWORK:-172.25.0.0/16}